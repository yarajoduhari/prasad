//library 'default@master'

pipeline {
  agent {
    kubernetes {
      yamlFile 'kubernetespod.yml'
    }
   }
    stages {
    stage('Init') {
      steps {
        script {
          // Build the jars
         git branch: 'star-credit', credentialsId: 'bitbucket', url: 'https://YHariPrasad@bitbucket.org/nobroker-repos/nb-creditline.git' 
            //git branch: 'main', url: 'https://YHariPrasad@bitbucket.org/nobroker-repos/tejas.git'
          // word length checker  
          //branchlint()
        }
      }
    }
    stage('maven') {
      steps{
       container('maven') {
           configFileProvider([configFile(fileId: 'nb-settings-xml', variable: 'MAVEN_SETTINGS_XML')]) {
           sh "mvn -T 3C -s $MAVEN_SETTINGS_XML clean install -DskipTests"
           sh "cp web/target/*.jar devops/."
        } 
            
        }
        }
      } 
     stage('Building docker and pushing image to nexus') {
      steps {
            container('docker') {
              sh '''
              cd  devops
              docker login http://localhost:8082 -uadmin -padmin123
              docker build -t localhost:8082/kube-nobroker/maven:$BUILD_NUMBER -f Dockerfile_blackbox .
              docker push localhost:8082/kube-local/maven:$BUILD_NUMBER
              '''
            }
          }
        }
     stage('helm deploying') {
      steps {
            container('helm') {
            script {
          git 'https://github.com/yarajoduhari/prasad.git'
       
          }
            sh '''
             #helm repo add  bitnami  https://charts.bitnami.com/bitnami
             #helm repo update
             #helm repo ls
             #helm install --help
             helm create nobroker
    
             helm install nobroker nobroker/ -n devops-tools --set serviceAccount.create=false --set serviceAccount.name=jenkins-admin --set image.repository=localhost:8082/kube-nobroker/maven --set image.tag="${BUILD_NUMBER}" --set service.type=NodePort --set service.port=8000  
             echo http://$NODE_IP:$NODE_PORT 
             '''
            }
        }
      }
    }
  }
