//library 'default@master'

pipeline {
  agent {
    kubernetes {
      yamlFile 'kubernetespod.yml'
    }
   }
    stages {
    stage('Init') {
      steps {
        script {
          // Build the jars
          git 'https://github.com/yarajoduhari/maven-standalone-application.git'
          // word length checker  
          branchlint()
          }
        }
      }
    stage('maven') {
      steps{
       container('maven') {
           sh " mvn clean install "
        }
        }
      }
     stage('Building docker and pushing image to nexus') {
      steps {
            container('docker') {
              sh '''
              docker login http://localhost:8082 -uadmin -padmin
              docker build -t localhost:8082/kube-docker/maven:$BUILD_NUMBER -f Dockerfile .
              docker push localhost:8082/kube-docker/maven:$BUILD_NUMBER
              '''
            }
          }
        }
     stage('helm deploying') {
      steps {
            container('helm') {
            script {
          git 'https://github.com/yarajoduhari/prasad.git'
       
          }
            sh '''
             helm create kubernetes
             cd kubernetes
             helm install . . --create-namespace --namespace devops-tools --set image.repository=kube-docker/maven --set image.tag="${BUILD_NUMBER}" --set serviceAccount.create=false --set service.type=NodePort --set service.port=32005
             '''
            } 
        }
      }
    }
  }
